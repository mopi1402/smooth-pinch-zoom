import{DragDetector as t}from"pithos/gestures/drag-detector";import{easeOutBack as i}from"pithos/animations/ease-functions";import{EventDebouncerManager as s}from"pithos/performance/event-debouncer-manager";import{WheelGestureHandler as o}from"pithos/gestures/wheel-handler";import{AnimationController as e}from"pithos/animations/animation-controller";import{parseViewportMeta as h}from"pithos/dom/viewport-parser";import{hasCSSZoom as n}from"pithos/dom/browser/browser-support";import{LocalStorage as r}from"pithos/data/storage/locale-storage";import{TouchGestureHandler as m}from"pithos/gestures/touch-handler";const a={minZoom:.5,maxZoom:2,initialZoom:1,wheelIncrement:.02,enableWheelZoom:!0,enablePinchZoom:!0,autoReadViewport:!0,enableZoomControl:!0,enableLocalStorage:!0,useExperimentalCssZoom:!1};class c{constructor(t){this.dragDetector=null,this.controls=t,this.element=this.createControl(),this.element.classList.add("hidden")}t(t){return this.controls.getZoom()+t}i(t){this.controls.animateZoom(t,{duration:300,easing:i})}createControl(){const t=document.createElement("div");t.className="zoom-control";const i=this.createButton("+",()=>{this.i(this.t(10))}),s=this.createZoomIndicator(),o=this.createButton("−",()=>{this.i(this.t(-10))}),e=this.createSeparator(),h=this.createSeparator(),n=this.createButton("↺",()=>{this.i(100)}),r=this.createButton("×",()=>{this.hide()});return t.appendChild(o),t.appendChild(s),t.appendChild(i),t.appendChild(e),t.appendChild(n),t.appendChild(h),t.appendChild(r),t}createButton(t,i){const s=document.createElement("button");return s.textContent=t,s.className="zoom-control-button",s.onclick=i,s}createZoomIndicator(){const t=document.createElement("div");return t.className="zoom-indicator",this.initializeDragDetector(t),t}initializeDragDetector(i){const s={onDragLeft:t=>{this.controls.zoomOut(Math.min(.5*t,2))},onDragRight:t=>{this.controls.zoomIn(Math.min(.5*t,2))}};this.dragDetector=new t(s,{threshold:2,axis:"x",gestureType:"mouse",preventDefaultOnStart:!0}),this.dragDetector.attachTo(i)}createSeparator(){const t=document.createElement("div");return t.className="zoom-separator",t}updateZoom(t){const i=this.element.querySelector(".zoom-indicator");if(i){const s=Math.round(100*t);i.textContent=`${s}%`}}show(){this.element.classList.remove("hidden"),this.element.classList.add("visible")}hide(){this.element.classList.remove("visible"),this.element.classList.add("hidden")}mount(){const t=document.createElement("div");t.className="zoom-container",this.element.style.pointerEvents="auto",t.appendChild(this.element),document.documentElement.appendChild(t)}getElement(){return this.element}destroy(){this.dragDetector&&(this.dragDetector.destroy(),this.dragDetector=null),this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}var u;!function(t){t.ZOOM_CHANGE="smoothZoomChange",t.ZOOM_APPLIED="smoothZoomApplied"}(u||(u={}));class d{constructor(t,i={}){this.isHovering=!1,this.handleZoomUpdate=t=>{if(t.type===u.ZOOM_CHANGE){const i=t;this.zoomControl.updateZoom(i.detail?.zoomLevel||1)}this.zoomControl.show(),this.isHovering||this.eventManager.trigger()},this.handleMouseEnter=()=>{this.isHovering=!0,this.eventManager.cancel()},this.handleMouseLeave=()=>{this.isHovering=!1,this.eventManager.trigger()},this.zoomControl=new c(t),this.eventManager=new s(()=>this.zoomControl.hide(),i.delay??3e3),this.setupEventListeners(),this.zoomControl.mount()}setupEventListeners(){window.addEventListener(u.ZOOM_CHANGE,this.handleZoomUpdate);const t=this.zoomControl.getElement();t&&(t.addEventListener("mouseenter",this.handleMouseEnter),t.addEventListener("mouseleave",this.handleMouseLeave))}destroy(){window.removeEventListener(u.ZOOM_CHANGE,this.handleZoomUpdate);const t=this.zoomControl.getElement();t&&(t.removeEventListener("mouseenter",this.handleMouseEnter),t.removeEventListener("mouseleave",this.handleMouseLeave)),this.eventManager.destroy(),this.zoomControl.destroy()}}class l{get config(){return this.o}constructor(t={}){this.currentZoom=1,this.baseZoom=1,this.isDestroyed=!1,this.isWheeling=!1;const i=t.autoReadViewport??a.autoReadViewport?h():{};this.o={...a,...t,minZoom:t.minZoom??i?.minimumScale??a.minZoom,maxZoom:t.maxZoom??i.maximumScale??a.maxZoom,initialZoom:t.initialZoom??i.initialScale??a.initialZoom},this.animationController=new e,!1!==this.o.enableZoomControl&&(this.zoomControlController=new d(this,{delay:3e3})),this.supportsCSSZoom=this.o.useExperimentalCssZoom&&n(),this.supportsCSSZoom||(document.body.style.transformOrigin="0 0"),this.init(),this.o.enableLocalStorage&&window.addEventListener("beforeunload",()=>{r.set("smooth-pinch-zoom-level",this.currentZoom)})}init(){this.o.enableLocalStorage?this.applyZoom(r.get("smooth-pinch-zoom-level",this.o.initialZoom)??this.o.initialZoom,"api"):1!==this.o.initialZoom&&this.applyZoom(this.o.initialZoom,"api"),this.o.enablePinchZoom&&this.setupPinchZoom(),this.o.enableWheelZoom&&this.setupWheelZoom()}setupPinchZoom(){"ontouchstart"in window&&(this.touchGestureHandler=new m(document,{onPinchStart:()=>{this.baseZoom=this.currentZoom},onPinchChange:t=>{const i=this.clampZoom(this.baseZoom*t);this.applyZoom(i,"pinch")},shouldAllowZoom:this.o.shouldAllowZoom}))}setupWheelZoom(){this.wheelGestureHandler=new o(document,{maxLogicalDistance:100,minDelay:200,maxDelay:300},{onStart:({startElement:t})=>{this.isDestroyed||this.o.shouldAllowZoom&&t&&!this.o.shouldAllowZoom("wheel",t)||(this.isWheeling=!0)},onWheel:({event:t})=>{if(!this.isDestroyed&&this.isWheeling&&(!this.o.shouldAllowZoom?.("wheel",t.target??void 0)||t.ctrlKey)){t.preventDefault();const i=t.deltaY>0?-this.o.wheelIncrement:this.o.wheelIncrement,s=this.clampZoom(this.currentZoom+i);this.currentZoom=s,this.applyZoom(s,"wheel")}},onEnd:()=>{this.isWheeling=!1}})}clampZoom(t){return Math.max(this.o.minZoom,Math.min(this.o.maxZoom,t))}applyZoom(t,i){this.o.customZoomApplicator?this.o.customZoomApplicator(t):this.applyDefaultZoom(t),this.currentZoom=t;const s=100*t;this.o.onZoomChange&&this.o.onZoomChange(t,s),window.dispatchEvent(new CustomEvent(u.ZOOM_CHANGE,{detail:{zoomLevel:t,percentage:s,source:i}}))}applyDefaultZoom(t){const i=Math.abs(t-1)<.001;if(document.documentElement.style.setProperty("--zoom",t.toString()),i)this.supportsCSSZoom?document.documentElement.style.removeProperty("zoom"):(document.body.style.removeProperty("willChange"),document.body.style.removeProperty("transform"),document.body.style.removeProperty("height"),document.body.style.removeProperty("width"));else if(this.supportsCSSZoom)document.documentElement.style.zoom=t.toString();else{document.body.style.willChange="transform",document.body.style.transform=`scale(${t})`;const i=1/t;document.body.style.width=100*i+"%",document.body.style.height=100*i+"%"}window.dispatchEvent(new CustomEvent(u.ZOOM_APPLIED,{detail:{zoomLevel:t,percentage:100*t,isDefaultState:i}}))}setZoom(t){if(this.o.shouldAllowZoom&&!this.o.shouldAllowZoom("api",void 0))return;const i=t/100,s=this.clampZoom(i);this.currentZoom=s,this.applyZoom(s,"api")}getZoom(){return 100*this.currentZoom}getMinZoom(){return this.o.minZoom}getMaxZoom(){return this.o.maxZoom}resetZoom(){const t=100*this.o.initialZoom;this.setZoom(t)}zoomIn(t=10){this.setZoom(this.getZoom()+t)}zoomOut(t=10){this.setZoom(this.getZoom()-t)}updateViewportConstraints(t){void 0!==t.minZoom&&(this.o.minZoom=t.minZoom),void 0!==t.maxZoom&&(this.o.maxZoom=t.maxZoom),void 0!==t.initialZoom&&(this.o.initialZoom=t.initialZoom);const i=this.clampZoom(this.currentZoom);i!==this.currentZoom&&this.setZoom(100*i)}animateZoom(t,i={}){const s=this.currentZoom,o=this.clampZoom(t/100);return this.animationController.animate(s,o,{duration:i.duration,easing:i.easing,onUpdate:t=>{this.currentZoom=t,this.applyZoom(t,"api")},onComplete:()=>{this.currentZoom=o,this.applyZoom(o,"api"),i.onComplete?.()}})}cancelAnimation(){this.animationController.cancel()}isAnimating(){return this.animationController.isAnimating()}destroy(){this.isDestroyed=!0,this.animationController.destroy(),this.touchGestureHandler&&this.touchGestureHandler.destroy(),this.wheelGestureHandler&&this.wheelGestureHandler.destroy(),this.zoomControlController&&this.zoomControlController.destroy()}}export{l as SmoothPinchZoom,u as ZoomEvents,l as default};
